### 一、概念

​	Redis是一种事件驱动程序，服务器需要处理两类事件：文件事件和时间事件。其中，文件事件是服务端程序对套接字操作的一种抽象，例如accept、read、write等。而时间事件是一些需要定时处理的操纵的抽象。

### 二、文件事件

​	Redis使用多路IO复用+文件事件分派器的结构来处理多个客户端连接。首先是多路IO，常见的方法有epoll、evport、select、kqueue，Redis会通过条件编译，自动选择当前系统中性能最高的方式。所监听的多个套接字有可能并发地产生文件事件，但多路IO复用程序会等到上一个套接字的文件事件处理完毕后再分配套接字给文件事件分派器。
​	文件事件的类型分为AE_READABLE和AE_WRITEABLE。当有新连接、客户端执行write或close时，套接字变为可读，将产生AE_READABLE事件，相应的，当客户端执行read操作时对应套接字产生AE_WEITEABLE事件。
​	Redis服务端允许套接字同时监听两种事件，如果套接字同时监听这两种事件，将会优先处理READABLE事件。等所有READABLE事件处理完毕后再处理WRITEABLE事件。也就是说如果一个套接字可读又可写的话，会先读后写。
​	再客户端连接服务器的整个过程中，服务器会一直为客户端套接字的READABLE事件绑定对应的命令请求处理器，而WRITEABLE事件则会在服务端需要回复客户端时才跟对应处理器绑定，回复命令发送完后，将解除这个绑定。

### 三、时间事件

​	Redis的时间事件分为定时事件和周期性事件，定时事件执行一次后就被删除，而周期事件将一直循环执行，这取决于处理函数的返回值是否为AE_NOMORE。Redis中时间事件由三个重要属性组成：id、when（毫秒精度的UNIX时间戳，记录时间事件的到达时间）、timeProc（时间事件处理器，一个函数）。
​	实现上，Redis将所有时间事件组织成一个无序链表，而其处理函数每次都将遍历这个链表，对比其到达时间和当前时间判断是否执行处理器（正常模式下Redis只有severCron一个函数，无序链表不影响性能）

### 四、事件的调度与执行

​	Redis中既有时间事件又有文件事件，二者的执行由一个函数完成：首先遍历时间事件链表，找到离当前时间最近的时间戳，将二者之差作为文件事件等待的阻塞时间(保证不为负数)，然后先阻塞等待文件事件发生，然后再去处理时间事件。