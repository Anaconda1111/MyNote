### 一、概念

​	Redis的所有数据都是保存在内存中，然后不定期的通过异步方式保存到磁盘上(这称为“半持久化模式”)；也可以把每一次数据变化都写入到一个append only file(aof)里面(这称为“全持久化模式”)。由于Redis的数据都存放在内存中，如果没有配置持久化，redis重启后数据就全丢失了，于是需要开启redis的持久化功能，将数据保存到磁盘上，当redis重启后，可以从磁盘中恢复数据。redis提供两种方式进行持久化，一种是RDB持久化（原理是将Reids在内存中的数据库记录定时dump到磁盘上的RDB持久化），另外一种是AOF（append only file）持久化（原理是将Reids的操作日志以追加的方式写入文件）。

### 二、RDB方式

​	RDB持久化是指在指定时间间隔内将内存中的数据集快照写入磁盘，实际操作为，先fork一个子进程，子进程将数据写到临时文件，写完后再替换之前的文件，文件后缀名为dmp。在RDB备份的整个过程中，主进程是不进行任何IO操作的，这确保了性能，如果需要**大规模恢复数据，且对数据恢复的完整性不敏感**，那么RDB比AOF合适。开启Redis客户端时，将自动读取rdb文件中的数据，以恢复至上一次关闭时的场景(可能并不完全一致)

#### 2.1 配置文件中的相关参数

	1. rdb文件保存路径：dir ./   （可以修改路径将文件放到其它地方）
 	2. 文件默认名称：dbfilename  dump.rdb
 	3. 快照时间配置：以下配置的意思是，60秒内10000次key改动，就保存、300秒内10次key改动就保存、3600秒内1次key改动就保存，这里可以自己改
           save 3600 1
           save  300  10
           save  60    10000
 	4. 检查文件完整性：rdbchecksum   yes   （增加10%性能消耗)

#### 2.2 优点和缺点

​	优势：

		1. 适合大规模数据恢复
  		2. 恢复速度快

​	劣势：

	1. Fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑
 	2.  在备份周期在一定间隔时间做一次备份，所以如果Redis意外down掉的话，就会丢失最后一次快照后的所有修改。  

### 三、AOF方式

​	以**日志**的形式来记录每个写操作（增量保存），将Redis执行过的所有写指令记录下来(**读操作不记录**)， **只许追加文件但不可以改写文件**，redis启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。当AOF和RDB服务同时开启时，默认取AOF文件进行恢复。

#### 3.1 配置文件中的相关参数

1.  appendonly   no   （默认为no，要开启AOF必须改为YES）
2.  appendfsync  [always everysec  no]  
    1.  always: 始终同步，每次Redis的写入都会立刻记入日志；性能较差但数据完整性比较好 
    2.  everysec:  每秒计入日志一次，如果宕机，本秒数据可能丢失
    3.  no:  不主动同步，同步时机交给操作系统
3.  no-appendfsync-on-rewrite：AOF文件持续增长而过大时，会fork出一条新进程来将文件重写(也是先写临时文件最后再rename)，redis4.0版本后的重写，是指上就是把rdb 的快照，以二级制的形式附在新的aof头部，作为已有的历史数据，替换掉原来的流水账操作。默认为no。

#### 3.2 优点和缺点

​	优点：

	1. 备份机制更稳健，丢失数据概率更低。
 	2.  可读的日志文本，通过操作AOF稳健，可以处理误操作。

​	缺点：

	1. 比起RDB占用更多的磁盘空间、恢复备份的速度更慢。
 	2. 每次读写都同步，会带来性能压力

