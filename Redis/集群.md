### 一、简介

​	集群是Redis的分布式数据库方案，通过分片进行数据共享，并提供复制和故障转移功能。

### 二、节点

​	一个Redis集群通常由多个节点组成，每个节点都是一个Redis服务端进程，只不过通过配置文件的cluster-enable选项将其配置为集群节点后跑的代码有点不一样。在最开始的时候，每个节点都是相互独立的，都处于一个只包括自己的集群当中。用CLUSTER MEET命令可以让节点另一个节点加到当前的集群当中。

#### 2.1 节点启动

​	节点启动后，不仅有redisServer结构来保存服务器状态、redisClient结构来保存客户端状态，还会创建一个clusterNode结构和clusterState结构保存节点相关信息：![1666288809746](../noteImage/1666288809746.png)

![1666288889300](../noteImage/1666288889300.png)

clusterNode结构用于保存一个节点的信息，Redis节点不仅会为自己创建clusterNode结构，还会为与其连接的、集群中的其它节点创建clusterNode结构，clusterState结构用于管理这多个clusterNode结构。

#### 2.2 CLUSTER MEET命令

​	命令的格式为 CLUSTER MEET <IP> <PORT>。通过向节点A发送该命令，可以令A与另外一个节点B进行握手。步骤如下：

*   A会为B创建一个clusterNode结构，并添加到clusterState的nodes字典当中，之后A根据命令中的端口号和IP地址向B发送一条MEET消息。
*   B收到A的MEET消息，为A创建一个clusterNode结构，并同样添加到字典当中，然后向A返回一条PONG消息。
*   A收到B的PONG消息，就知道B已经成功接收了自己的MEET消息，之后A向B返回PING消息
*   B收到PING消息后知道A已经接收到了PONG消息，握手完成！
*   之后A会将B的信息传播给集群中的其它节点，让其它节点也与B握手。

### 三、槽指派

​	所谓槽是一个抽象的概念，并不是说真的弄了个容器。**Redis集群中，一个槽本质上就是一个数字**，数据库中数据的key经过一个函数的计算后可以得到一个数字，那么就说这个键值对属于这个数字，也就是属于这个槽。Redis集群一共有16384个槽，每个节点可以负责处理若干个槽。当数据库中16384个槽都有节点在负责处理时，集群处于上线状态，否则集群处于下线状态。可以用命令CLUSTER ADDSLOTS命令指派一个或多个槽。

#### 3.1 节点如何记录自己负责的槽

​	在clusterNode结构中，有一个数组：unsigned char slots [16384/8]和一个整数numslots用于记录槽。slots的作用是一个二进制数组，其每一位代表着对应的槽是否被当前节点处理，因此大小是16384/8。

#### 3.2 传播节点的槽指派信息

​	一个节点除了记录自己的槽信息，还要记录集群中其它节点的槽信息。因此每个节点会将自己的槽信息，也就是slots数组发给集群中的其它节点，其它节点拿到这个数组后将其保存在clusterState结构中对应的源节点的clusterNode结构中。

#### 3.3 如何快速知道某个槽属于哪个节点

​	仅仅依靠clusterNode结构中的slots数组无法快速判断某个槽是否被分配以及由哪个节点负责。而解决方案就是在clusterState结构中接入一个数组：clusterNode* slots[16384]。这个数组用于记录某个槽是被哪个节点处理，如果没有则为NULL，有则指向这个节点对应的clusterNode结构。

#### 3.4 CLUSTER ADDSLOTS命令的实现

​	这个命令接收一个或多个槽作为参数，例如 CLUSTER ADDSLOTS 1 2  代表将槽1和2分配给当前节点处理。执行这个命令时，首先检查输入的槽是否已经被分配，只要有一个是，则向客户端返回错误并终止命令执行。然后遍历所有输入槽，将其指派给当前节点。最后，执行完毕时发消息告诉集群中的其它节点，自己目前正在处理哪些槽。

### 四、集群中执行命令

​	客户端向某个节点发送命令去操作某个键值对时，节点首先根据key算出键值对属于哪个槽，然后判断这个槽是不是由自己负责，如果是则正常处理命令，否则向客户端返回MOVED错误。这个MOVED错误对于集群模式的redis-cli客户端，将会被隐藏，而是根据MOVED错误自动进行节点转向(转向槽所对应的节点)，并打印出转向信息。而如果是单机模式的客户端，则MOVED错误会被打印出来。
​	集群模式的客户端一般与集群中的所有节点都有连接，节点转向本质上就是换一个TCP套接字进行通信。