## 一、概述

​	电子邮件是一种非实时的通信应用。发件人将邮件发送到邮件服务器，邮件服务器再将报文发送到收件人的邮箱服务器，然后再发送给收件人的用户代理(User Agent)，这样做的好处是不要求用户必须24小时在线。如果是之间在用户之间建立连接进行邮件收发，接收端如果不在线则邮件发送失败，显然采用服务器进行异步通信的方式更加合理。
​	一个电子邮件系统具有三个主要组成构件：用户代理、邮件服务器以及发送协议(如SMTP)和邮件读取协议(如POP3、IMAP等)
​	用户代理(UA)即用户与电子邮件系统的接口，是一个计算机中的程序，又被称为电子邮件客户端软件
​	邮件服务器则是负责缓存和收发邮件，同时还要报告邮件传送结果。邮件服务器需要两种不同的协议，一种用于用户代理向服务器发送邮件或服务器之间发送邮件(如SMTP)，一种用于用户代理从服务器读取邮件，如POP3。SMTP,POP3(或IMAP)都是用TCP连接来传送邮件的，目的是为了可靠的传送邮件。
​	TCP/IP体系的电子邮件系统规定电子邮件地址格式为：用户名@邮件服务器的域名。

## 二、简单邮件传送协议SMTP

​	SMTP规定了两个互相通信的SMTP进程之间如何交换信息，可以说，发送邮件的SMTP进程就是SMTP客户，而负责接收邮件的SMTP进程就是SMTP服务器。SMTP规定了14条命令和21种应答信息，每条命令由几个字母组成。

### 2.1 连接建立

​	发送者发送邮件到邮件服务器的缓存后，邮件服务器会每隔一段时间对邮件缓存扫描一次，发现有邮件就用SMTP的端口号码25与接收方的SMTP服务器建立TCP连接。连接建立后，接收方服务器发出“220 Service ready”，然后SMTP客户向SMTP服务器发送HELO指令，附上发送方的主机名，若对方有能力接收邮件则回答“250 OK"。若不可用，则回答”421 Service not available“。若一段时间内发送不了邮件就把这个情况通知发件人。

### 2.2 邮件传送

​	邮件的传送从MAIL命令开始。MAIL命令后有发件人的地址，如MAIL FROM:<xiexiren@tsinghua.org.cn>，若SMTP服务器已经准备好接收邮件，则回答”250 OK“，否则返回一个代码并指出原因，如451(处理时出错)，452(存储空间不够)
​	下面跟着一个或多个RCPT命令，其格式为RCPT TO:<收件人地址>，每发送一个RCPT都有相应的信息从服务器返回，如”250 OK“，指明邮箱在接收方的系统中，或者“550 No such user here”，表示不存在此邮箱。
​	接下来就是DATA命令，表示要开始发送邮件内容。SMTP返回354则正常，若返回421(服务器不可用)，500(命令无法识别)，接着就发送邮件内容，完成后发送<CRLF>.<CRLF>表示内容结束，服务器接收到后返回250 OK。

### 2.3 连接释放

​	邮件发送完毕后，SMTP客户应发送QUIT命令，SMTP服务器返回221，表示SMTP同意释放TCP连接。邮件传送的全过程结束。

## 三、电子邮件的信息格式

​	电子邮件分为信封和内容两大部分。邮件内容的首部由RFC 5322文档规定，内容主体则由用户自己填写。邮件内容首部包括一些关键字：

1.  关键字To：后填入一个或多个收件人的地址。

 	2. 关键字Subject：是邮件的主题，反映了邮件的主要内容，便于用户查找
 	3. 关键字From：发件人的电子邮件地址
 	4. 关键字Date：发信日期

## 四、邮件读取协议POP3和IMAP

​	POP3协议的一大特点就是用户读取完邮件后服务器就把邮件删除，这在某些情况下非常不方便。而另一个协议IMAP就不存在这个问题，IMAP在用户的计算机上运行IMAP客户程序，用户在自己的计算机上就可以操作邮件服务器，而且可以为自己的邮箱创建层次式的邮箱文件夹，IMAP允许只读取邮件中的一部分内容，且IMAP的用户如果没有把邮件复制到自己的计算机上则会一直存放在IMAP服务器里，导致每次查看都必须联网。
​	在今天的主流Email应用中，几乎都用HTTP协议来读取邮件，当然邮件服务器之间的传输依然使用SMTP协议。

## 五、通用互联网邮件扩充MIME

	### 5.1 概述

​	SMTP具有几个明显缺点：它不能传送可执行文件和其它二进制对象、仅限于传送7位的ASCII码、服务器会拒绝超过一定长度的邮件等。MIME的提出改进了这种情况，且它并没有改动或取代SMTP，而是继续使用原来的邮件格式但增加了邮件主体的结构并定义了传送非ASCII码的编码规则。MIME包括5个新的邮件首部字段、定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行标准化、定义了传送编码，可对任何内容格式进行转换。其中5个新的邮件首部字段为：

	1. MIME-Version：标志MIME的版本
 	2. Content-Description：可读字符串，表示邮件主题是否是图像、音频、视频
 	3. Content-ID：邮件标识符
 	4. Content-Transfer-Encoding：在传送邮件时如何编码
 	5. Content-Type：说明邮件主体的数据类型和子类型

### 5.2 内容传送编码

 1.    最简单的7位ASCII码，每行不能超过1000个字符。MIME对这种编码构成的主体不进行转换。

 2.    quoted-printable：对可打印的ASCII码除“=”外不改变，“=”和非ASCII码的编码方式是：先将每个字节的二进制代码用两个十六进制数表示，然后再前面加上一个等号。例如：汉字“系统”的二进制编码为11001111 10110101 11001101 10110011共32位，其十六进制为CFB5CDB3，用quoted-printable编码就表示为：=CF=B5=CD=B3，而这十二个字符都是可打印的ASCII字符。

 3.    base64：先把二进制代码划分为一个个24位长的单元，然后每个24位单元分为4个6位组，6个二进制代码工有64种不同的值，A表示0，B表示1等等，到26个大写字母后再排列26个小写字母，然后是10个数字，然后“+”表示62，“/”表示63。而这些符号都是可打印的ASCII码。

       ```C
       // 24位二进制代码：010010 010011 000101 111001
       //换成base64：		S		T	  F		5
       //用ASCII码发送	  01010011 01010100  01000110 00110101
       ```

### 5.3 内容类型

​	内容类型必须有两个标识符，即内容类型和子类型，中间用/分隔开。常用的内容类型和子类型有：
​		内容类型										子类型										说明
​		text（文本）                              plain,html,xml,css                          不同格式的文本
​		image（图像）                         gif,jpeg,tiff,png                                不同格式的静止图像
​		audio（音频）						  basic,mepg,mp4							 可听见的声音
​		video（视频）						  mpeg,mp4,quicktime					   不同格式的影片
​		model（模型）						 vrml												 3D模型
​		application（应用）				  pdf,javascript,zip							 不同应用产生的数据
​		message（报文）					 http,rfc822									   封装的报文
​		multipart（多部分）		mixed,alternative,parallel,digest				多种类型的组合

其中multipart是很有用的，它使邮件增加了相当大的灵活性。·

1.  mixed：mixed子类型允许单个报文拥有多个互相独立的子报文，每个子报文可以有自己的类型和编码，使得用户能够在单个报文中附上文本、图形和声音。在mixed后要加上一个关键字，即Boundary=，此关键字定义了分割各报文所用字符串，当某行以--开始，表示下面开始另一个子报文。
2.  alternative：允许单个报文含有同一数据的多种表示。用户可用普通的ASCII文本发送文本，从而允许有图形功能的用户查看时选择格式化的形式。
3.  parallel：允许单个报文含有可同时显式的各个子部分，例如图像和声音字部份一起播放
4.  digest：允许单个报文含有一组其他报文，例如从讨论中手机电子邮件报文7